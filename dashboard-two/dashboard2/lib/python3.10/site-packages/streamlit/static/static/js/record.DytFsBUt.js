function W(p,t,i,e){return new(i||(i=Promise))((function(s,o){function r(u){try{d(e.next(u))}catch(l){o(l)}}function n(u){try{d(e.throw(u))}catch(l){o(l)}}function d(u){var l;u.done?s(u.value):(l=u.value,l instanceof i?l:new i((function(m){m(l)}))).then(r,n)}d((e=e.apply(p,[])).next())}))}class b{constructor(){this.listeners={}}on(t,i,e){if(this.listeners[t]||(this.listeners[t]=new Set),e?.once){const s=(...o)=>{this.un(t,s),i(...o)};return this.listeners[t].add(s),()=>this.un(t,s)}return this.listeners[t].add(i),()=>this.un(t,i)}un(t,i){var e;(e=this.listeners[t])===null||e===void 0||e.delete(i)}once(t,i){return this.on(t,i,{once:!0})}unAll(){this.listeners={}}emit(t,...i){this.listeners[t]&&this.listeners[t].forEach((e=>e(...i)))}}class D extends b{constructor(t){super(),this.subscriptions=[],this.isDestroyed=!1,this.options=t}onInit(){}_init(t){this.isDestroyed&&(this.subscriptions=[],this.isDestroyed=!1),this.wavesurfer=t,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((t=>t())),this.subscriptions=[],this.isDestroyed=!0,this.wavesurfer=void 0}}class S extends b{constructor(){super(...arguments),this.animationFrameId=null,this.isRunning=!1}start(){if(this.isRunning)return;this.isRunning=!0;const t=()=>{this.isRunning&&(this.emit("tick"),this.animationFrameId=requestAnimationFrame(t))};t()}stop(){this.isRunning=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}destroy(){this.stop()}}const R=100,P=["audio/webm","audio/wav","audio/mpeg","audio/mp4","audio/mp3"];class y extends D{constructor(t){var i,e,s,o,r,n;super(Object.assign(Object.assign({},t),{audioBitsPerSecond:(i=t.audioBitsPerSecond)!==null&&i!==void 0?i:128e3,scrollingWaveform:(e=t.scrollingWaveform)!==null&&e!==void 0&&e,scrollingWaveformWindow:(s=t.scrollingWaveformWindow)!==null&&s!==void 0?s:5,continuousWaveform:(o=t.continuousWaveform)!==null&&o!==void 0&&o,renderRecordedAudio:(r=t.renderRecordedAudio)===null||r===void 0||r,mediaRecorderTimeslice:(n=t.mediaRecorderTimeslice)!==null&&n!==void 0?n:void 0})),this.stream=null,this.mediaRecorder=null,this.dataWindow=null,this.isWaveformPaused=!1,this.lastStartTime=0,this.lastDuration=0,this.duration=0,this.micStream=null,this.recordedBlobUrl=null,this.timer=new S,this.subscriptions.push(this.timer.on("tick",(()=>{const d=performance.now()-this.lastStartTime;this.duration=this.isPaused()?this.duration:this.lastDuration+d,this.emit("record-progress",this.duration)})))}static create(t){return new y(t||{})}renderMicStream(t){var i;const e=new AudioContext,s=e.createMediaStreamSource(t),o=e.createAnalyser();s.connect(o),(this.options.continuousWaveform||this.options.scrollingWaveform)&&(o.fftSize=32);const r=o.frequencyBinCount,n=new Float32Array(r);let d=0;this.wavesurfer&&((i=this.originalOptions)!==null&&i!==void 0||(this.originalOptions=Object.assign({},this.wavesurfer.options)),this.wavesurfer.options.interact=!1,this.options.scrollingWaveform&&(this.wavesurfer.options.cursorWidth=0,this.wavesurfer.options.normalize=!0,this.wavesurfer.options.maxPeak=1));const u=setInterval((()=>{var l,m,w,g;if(!this.isWaveformPaused){if(o.getFloatTimeDomainData(n),this.options.scrollingWaveform){const h=Math.floor((this.options.scrollingWaveformWindow||0)*R);let a=0;for(let v=0;v<r;v++){const f=Math.abs(n[v]);f>a&&(a=f)}this.dataWindow||(this.dataWindow=new Float32Array(h));const c=new Float32Array(h);if(this.dataWindow&&this.dataWindow.length>0){const v=h-1,f=this.dataWindow.slice(-v);c.set(f,0)}c[h-1]=a,this.dataWindow=c}else if(this.options.continuousWaveform){if(!this.dataWindow){const a=this.options.continuousWaveformDuration?Math.round(this.options.continuousWaveformDuration*R):((m=(l=this.wavesurfer)===null||l===void 0?void 0:l.getWidth())!==null&&m!==void 0?m:0)*window.devicePixelRatio;this.dataWindow=new Float32Array(a)}let h=0;for(let a=0;a<r;a++){const c=Math.abs(n[a]);c>h&&(h=c)}if(d+1>this.dataWindow.length){const a=new Float32Array(2*this.dataWindow.length);a.set(this.dataWindow,0),this.dataWindow=a}this.dataWindow[d]=h,d++}else this.dataWindow=n;if(this.wavesurfer){const h=((g=(w=this.dataWindow)===null||w===void 0?void 0:w.length)!==null&&g!==void 0?g:0)/R;this.wavesurfer.load("",[this.dataWindow],this.options.scrollingWaveform?this.options.scrollingWaveformWindow:h).then((()=>{this.wavesurfer&&this.options.continuousWaveform&&(this.wavesurfer.setTime(this.getDuration()/1e3),this.wavesurfer.options.minPxPerSec||this.wavesurfer.setOptions({minPxPerSec:this.wavesurfer.getWidth()/this.wavesurfer.getDuration()}))})).catch((a=>{console.error("Error rendering real-time recording data:",a)}))}}}),10);return{onDestroy:()=>{clearInterval(u),s?.disconnect(),e?.close()},onEnd:()=>{this.isWaveformPaused=!0,this.stopMic()}}}startMic(t){return W(this,void 0,void 0,(function*(){let i;this.micStream&&this.stopMic();try{i=yield navigator.mediaDevices.getUserMedia({audio:t==null||t})}catch(s){throw new Error("Error accessing the microphone: "+s.message)}const e=this.renderMicStream(i);return this.micStream=e,this.unsubscribeDestroy=this.once("destroy",e.onDestroy),this.unsubscribeRecordEnd=this.once("record-end",e.onEnd),this.stream=i,i}))}stopMic(){var t,i,e;(t=this.micStream)===null||t===void 0||t.onDestroy(),(i=this.unsubscribeDestroy)===null||i===void 0||i.call(this),(e=this.unsubscribeRecordEnd)===null||e===void 0||e.call(this),this.micStream=null,this.unsubscribeDestroy=void 0,this.unsubscribeRecordEnd=void 0,this.stream&&(this.stream.getTracks().forEach((s=>s.stop())),this.stream=null,this.mediaRecorder=null)}startRecording(t){return W(this,void 0,void 0,(function*(){const i=this.stream||(yield this.startMic(t));this.dataWindow=null;const e=this.mediaRecorder||new MediaRecorder(i,{mimeType:this.options.mimeType||P.find((r=>MediaRecorder.isTypeSupported(r))),audioBitsPerSecond:this.options.audioBitsPerSecond});this.mediaRecorder=e,this.stopRecording();const s=[];e.ondataavailable=r=>{r.data.size>0&&s.push(r.data),this.emit("record-data-available",r.data)};const o=r=>{var n;const d=new Blob(s,{type:e.mimeType});this.emit(r,d),this.options.renderRecordedAudio&&(this.applyOriginalOptionsIfNeeded(),this.recordedBlobUrl&&URL.revokeObjectURL(this.recordedBlobUrl),this.recordedBlobUrl=URL.createObjectURL(d),(n=this.wavesurfer)===null||n===void 0||n.load(this.recordedBlobUrl))};e.onpause=()=>o("record-pause"),e.onstop=()=>o("record-end"),e.start(this.options.mediaRecorderTimeslice),this.lastStartTime=performance.now(),this.lastDuration=0,this.duration=0,this.isWaveformPaused=!1,this.timer.start(),this.emit("record-start")}))}getDuration(){return this.duration}isRecording(){var t;return((t=this.mediaRecorder)===null||t===void 0?void 0:t.state)==="recording"}isPaused(){var t;return((t=this.mediaRecorder)===null||t===void 0?void 0:t.state)==="paused"}isActive(){var t;return((t=this.mediaRecorder)===null||t===void 0?void 0:t.state)!=="inactive"}stopRecording(){var t;this.isActive()&&((t=this.mediaRecorder)===null||t===void 0||t.stop(),this.timer.stop())}pauseRecording(){var t,i;this.isRecording()&&(this.isWaveformPaused=!0,(t=this.mediaRecorder)===null||t===void 0||t.requestData(),(i=this.mediaRecorder)===null||i===void 0||i.pause(),this.timer.stop(),this.lastDuration=this.duration)}resumeRecording(){var t;this.isPaused()&&(this.isWaveformPaused=!1,(t=this.mediaRecorder)===null||t===void 0||t.resume(),this.timer.start(),this.lastStartTime=performance.now(),this.emit("record-resume"))}static getAvailableAudioDevices(){return W(this,void 0,void 0,(function*(){return navigator.mediaDevices.enumerateDevices().then((t=>t.filter((i=>i.kind==="audioinput"))))}))}destroy(){this.applyOriginalOptionsIfNeeded(),super.destroy(),this.stopRecording(),this.stopMic(),this.recordedBlobUrl&&(URL.revokeObjectURL(this.recordedBlobUrl),this.recordedBlobUrl=null)}applyOriginalOptionsIfNeeded(){this.wavesurfer&&this.originalOptions&&(this.wavesurfer.setOptions(this.originalOptions),delete this.originalOptions)}}export{y as default};
